name: The Gathering Frontend CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: "ğŸ“¥ Checkout Repository"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: "âš™ï¸ Setup Node.js 20"
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: "ğŸ“¦ Install Dependencies"
      run: npm ci

    - name: "ğŸ” ESLint Check"
      run: npx eslint .

    - name: "ğŸ” TypeScript Type Check"
      run: npx tsc --noEmit

    - name: "ğŸ§ª Run Unit Tests"
      run: npm run test:unit

    - name: "ğŸ§ª Run Integration Tests"
      run: npm run test:integration

    - name: "ğŸ—ï¸ Production Build Test"
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: http://130.61.246.212
        BACKEND_URL: http://130.61.246.212
        NEXT_PUBLIC_APP_NAME: The Gathering
        NEXT_PUBLIC_APP_URL: https://the-gathering.vercel.app

  security:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: "ğŸ“¥ Checkout Repository"
      uses: actions/checkout@v4

    - name: "âš™ï¸ Setup Node.js 20"
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: "ğŸ“¦ Install Dependencies"
      run: npm ci

    - name: "ğŸ”’ Dependency Vulnerability Scan"
      run: |
        npm audit --audit-level=moderate > npm-audit-report.txt || true
        npm audit --json > npm-audit-report.json || echo '{"vulnerabilities": {}}' > npm-audit-report.json

    - name: "ğŸ“‹ Upload Security Reports"
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          npm-audit-report.txt
          npm-audit-report.json
        retention-days: 7

  quality-gate:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always()

    steps:
    - name: "âœ… Quality Gate Check"
      run: |
        echo "ğŸ¯ The Gathering Frontend Quality Gate"
        echo ""

        # Check test job result
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… Linting: Passed"
          echo "âœ… Type Check: Passed"
          echo "âœ… Unit Tests: Passed"
          echo "âœ… Integration Tests: Passed"
          echo "âœ… Build: Passed"
        else
          echo "âŒ Tests: Failed"
          TEST_FAILED=true
        fi

        # Check security job result
        if [ "${{ needs.security.result }}" == "success" ]; then
          echo "âœ… Security: Scanned"
        elif [ "${{ needs.security.result }}" == "skipped" ]; then
          echo "â­ï¸  Security: Skipped"
        else
          echo "âŒ Security: Failed"
          SECURITY_FAILED=true
        fi

        echo ""

        # Determine overall status
        if [ "$TEST_FAILED" == "true" ] || [ "$SECURITY_FAILED" == "true" ]; then
          echo "âŒ Quality Gate: FAILED"
          echo "ğŸš« NOT ready for deployment!"
          exit 1
        else
          echo "âœ… Quality Gate: PASSED"
          echo "ğŸš€ Ready for Vercel deployment!"
          exit 0
        fi
